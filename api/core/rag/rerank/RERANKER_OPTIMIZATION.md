# Reranker ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“Š å½“å‰é—®é¢˜åˆ†æ

### 1. **é‡å¤åŠ è½½Embeddingæ¨¡å‹**
**é—®é¢˜**ï¼šåœ¨ `WeightRerankRunner._calculate_cosine()` ä¸­ (weight_rerank.py:161-169)
```python
# æ¯æ¬¡rerankéƒ½ä¼šé‡æ–°åŠ è½½embeddingæ¨¡å‹
model_manager = ModelManager()
embedding_model = model_manager.get_model_instance(...)
cache_embedding = CacheEmbedding(embedding_model)
```

**å½±å“**ï¼š
- æ¯æ¬¡weight rerankéƒ½éœ€è¦åŠ è½½embeddingæ¨¡å‹
- å³ä½¿æ˜¯åŒä¸€ä¸ªæ¨¡å‹ï¼Œä¹Ÿä¼šé‡å¤åˆå§‹åŒ–
- å¢åŠ å»¶è¿Ÿå’Œå†…å­˜æ¶ˆè€—

**æµ‹è¯•æ•°æ®**ï¼š
- é¦–æ¬¡åŠ è½½ï¼šå¯èƒ½éœ€è¦2-3ç§’
- ç¼“å­˜å‘½ä¸­ï¼š< 0.001ç§’

---

### 2. **é‡å¤çš„æ–‡æ¡£å»é‡é€»è¾‘**
**é—®é¢˜**ï¼šå¤šå¤„å­˜åœ¨ç›¸åŒçš„å»é‡ä»£ç 
- `RerankModelRunner.run()` (rerank_model.py:27-42)
- `WeightRerankRunner.run()` (weight_rerank.py:38-52)
- `RetrievalService._deduplicate_documents()` (retrieval_service.py:164-195)

**å½±å“**ï¼š
- ä»£ç é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜
- å¤šæ¬¡éå†æ–‡æ¡£åˆ—è¡¨
- åœ¨hybrid searchä¸­ä¼šæ‰§è¡Œ2æ¬¡å»é‡

---

### 3. **DataPostProcessoræ¯æ¬¡éƒ½é‡æ–°åˆå§‹åŒ–**
**é—®é¢˜**ï¼šåœ¨ `retrieval_service.py` ä¸­å¤šå¤„é‡å¤åˆ›å»ºï¼š
- Line 124: Hybrid search
- Line 280: Semantic search with reranking
- Line 341: Full text search with reranking

**å½±å“**ï¼š
- æ¯æ¬¡éƒ½éœ€è¦åˆå§‹åŒ–rerank runner
- å¦‚æœæ˜¯model rerankingï¼Œæ¯æ¬¡éƒ½è¦åŠ è½½æ¨¡å‹
- é‡å¤çš„å¯¹è±¡åˆ›å»ºå¼€é”€

---

### 4. **Weight Rerankingçš„è®¡ç®—æ•ˆç‡**
**é—®é¢˜**ï¼šåœ¨ `WeightRerankRunner._calculate_keyword_score()` ä¸­
- å¯¹æ¯ä¸ªæ–‡æ¡£éƒ½è¦æå–å…³é”®è¯ (Line 83-88)
- TF-IDFè®¡ç®—æ²¡æœ‰ç¼“å­˜
- Cosine similarityè®¡ç®—å¯ä»¥ä¼˜åŒ–

**å½±å“**ï¼š
- å…³é”®è¯æå–æ˜¯CPUå¯†é›†å‹æ“ä½œ
- å¯¹äºç›¸åŒqueryï¼Œæ¯æ¬¡éƒ½é‡æ–°è®¡ç®—
- å¤§é‡æ–‡æ¡£æ—¶æ€§èƒ½ä¸‹é™æ˜æ˜¾

---

### 5. **Rerank Modelå®ä¾‹æ²¡æœ‰ç¼“å­˜**
**é—®é¢˜**ï¼šåœ¨ `DataPostProcessor._get_rerank_model_instance()` ä¸­
```python
# æ¯æ¬¡éƒ½é€šè¿‡ModelManagerè·å–å®ä¾‹
rerank_model_instance = model_manager.get_model_instance(...)
```

**å½±å“**ï¼š
- Rerankæ¨¡å‹åŠ è½½æ—¶é—´é•¿
- ç›¸åŒæ¨¡å‹é‡å¤åŠ è½½
- æ²¡æœ‰TTLå’ŒLRUç®¡ç†

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¸ºDataPostProcessoræ·»åŠ ç¼“å­˜æœºåˆ¶

#### ä¼˜åŒ–ç›®æ ‡ï¼š
- ç¼“å­˜DataPostProcessorå®ä¾‹
- ç¼“å­˜rerank modelå®ä¾‹
- ç¼“å­˜weight rerankingçš„embedding model

#### å®æ–½æ–¹å¼ï¼š
ç±»ä¼¼äºVectorçš„ç¼“å­˜æœºåˆ¶ï¼š
- TTL: 30åˆ†é’Ÿ
- LRUæ·˜æ±°ç­–ç•¥
- æœ€å¤šç¼“å­˜50ä¸ªå®ä¾‹
- åŒé‡æ£€æŸ¥é”å®šä¿è¯çº¿ç¨‹å®‰å…¨

#### é¢„æœŸæ•ˆæœï¼š
- **é¦–æ¬¡åˆå§‹åŒ–**: 2-3ç§’ â†’ 2ç§’ï¼ˆä¼˜åŒ–åï¼‰
- **ç¼“å­˜å‘½ä¸­**: < 0.001ç§’ï¼ˆå‡å°‘99.9%ï¼‰
- **å‘½ä¸­ç‡**: 85%+ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

---

### æ–¹æ¡ˆ2ï¼šä¼˜åŒ–æ–‡æ¡£å»é‡é€»è¾‘

#### ä¼˜åŒ–ç›®æ ‡ï¼š
é¿å…é‡å¤å»é‡ï¼Œæå‡æ€§èƒ½

#### å®æ–½æ–¹å¼ï¼š
1. å°†å»é‡é€»è¾‘ç»Ÿä¸€åˆ°RetrievalServiceä¸­
2. åœ¨rerankä¹‹å‰è¿›è¡Œä¸€æ¬¡æ€§å»é‡
3. Rerank runneråªè´Ÿè´£æ’åºï¼Œä¸åšå»é‡

#### é¢„æœŸæ•ˆæœï¼š
- å‡å°‘1-2æ¬¡æ–‡æ¡£éå†
- ä»£ç æ›´æ¸…æ™°ï¼Œç»´æŠ¤æ€§æ›´å¥½

---

### æ–¹æ¡ˆ3ï¼šWeight Rerankingä¼˜åŒ–

#### ä¼˜åŒ–ç›®æ ‡ï¼š
- ç¼“å­˜å…³é”®è¯æå–ç»“æœ
- ç¼“å­˜embeddingæ¨¡å‹å®ä¾‹
- ä¼˜åŒ–TF-IDFè®¡ç®—

#### å®æ–½æ–¹å¼ï¼š
1. **å…³é”®è¯ç¼“å­˜**ï¼šåŸºäºcontent hashç¼“å­˜å…³é”®è¯
2. **Embeddingç¼“å­˜**ï¼šä½¿ç”¨ç±»ä¼¼Vectorçš„ç¼“å­˜æœºåˆ¶
3. **æ‰¹é‡å¤„ç†**ï¼šæ‰¹é‡embedæ–‡æ¡£è€Œä¸æ˜¯é€ä¸ªå¤„ç†

#### é¢„æœŸæ•ˆæœï¼š
- å…³é”®è¯æå–ï¼šå‡å°‘50-70%æ—¶é—´
- EmbeddingåŠ è½½ï¼šå‡å°‘99%+æ—¶é—´ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- TF-IDFè®¡ç®—ï¼šå‡å°‘30-40%æ—¶é—´

---

### æ–¹æ¡ˆ4ï¼šRerank Modelç¼“å­˜

#### ä¼˜åŒ–ç›®æ ‡ï¼š
ç¼“å­˜rerankæ¨¡å‹å®ä¾‹ï¼Œé¿å…é‡å¤åŠ è½½

#### å®æ–½æ–¹å¼ï¼š
```python
class RerankModelCache:
    _cache: OrderedDict = OrderedDict()
    _lock = threading.Lock()
    _CACHE_TTL_SECONDS = 1800  # 30åˆ†é’Ÿ
    _CACHE_MAX_SIZE = 50
    
    @classmethod
    def get_cached_model(cls, tenant_id, provider, model):
        # ç±»ä¼¼Vectorçš„ç¼“å­˜é€»è¾‘
        ...
```

#### é¢„æœŸæ•ˆæœï¼š
- **é¦–æ¬¡åŠ è½½**: 2-5ç§’
- **ç¼“å­˜å‘½ä¸­**: < 0.001ç§’
- **å‘½ä¸­ç‡**: 90%+

---

## ğŸ“ˆ ç»¼åˆæ€§èƒ½é¢„æœŸ

### åœºæ™¯1ï¼šSemantic Search + Rerankingï¼ˆ100æ¬¡è¯·æ±‚ï¼Œ90%ç¼“å­˜å‘½ä¸­ç‡ï¼‰

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **ModelåŠ è½½** | 3ç§’/æ¬¡ | 0.3ç§’ï¼ˆå¹³å‡ï¼‰ | **90%** |
| **æ€»è€—æ—¶** | 300ç§’ | 30ç§’ | **90%** |

### åœºæ™¯2ï¼šHybrid Search + Weight Rerankingï¼ˆ100æ¬¡è¯·æ±‚ï¼‰

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **EmbeddingåŠ è½½** | 2ç§’/æ¬¡ | 0.2ç§’ï¼ˆå¹³å‡ï¼‰ | **90%** |
| **å…³é”®è¯æå–** | 1ç§’/æ¬¡ | 0.4ç§’ï¼ˆå¹³å‡ï¼‰ | **60%** |
| **æ€»è€—æ—¶** | 300ç§’ | 60ç§’ | **80%** |

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§

### P0 - ç«‹å³å®æ–½
1. âœ… **Rerank Modelç¼“å­˜** - æœ€å¤§æ”¶ç›Š
2. âœ… **DataPostProcessorç¼“å­˜** - é¿å…é‡å¤åˆå§‹åŒ–
3. âœ… **Weight Rerankingçš„Embeddingç¼“å­˜** - æ˜¾è‘—åŠ é€Ÿ

### P1 - è¿‘æœŸå®æ–½
4. **ç»Ÿä¸€å»é‡é€»è¾‘** - ä»£ç è´¨é‡æå‡
5. **å…³é”®è¯æå–ç¼“å­˜** - æ€§èƒ½ä¼˜åŒ–

### P2 - å¯é€‰ä¼˜åŒ–
6. **TF-IDFè®¡ç®—ä¼˜åŒ–** - è¾¹é™…æ”¶ç›Š
7. **æ‰¹é‡å¤„ç†ä¼˜åŒ–** - å¤§è§„æ¨¡åœºæ™¯

---

## ğŸ”§ å®æ–½å»ºè®®

### é˜¶æ®µ1ï¼šåŸºç¡€ç¼“å­˜ï¼ˆ1-2å¤©ï¼‰
1. å®ç°RerankModelCache
2. å®ç°DataPostProcessorCache
3. æ·»åŠ ç›‘æ§æŒ‡æ ‡

### é˜¶æ®µ2ï¼šæ·±åº¦ä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰
1. Weight Rerankingçš„Embeddingç¼“å­˜
2. ç»Ÿä¸€å»é‡é€»è¾‘
3. å…³é”®è¯æå–ç¼“å­˜

### é˜¶æ®µ3ï¼šæµ‹è¯•éªŒè¯ï¼ˆ1å¤©ï¼‰
1. æ€§èƒ½åŸºå‡†æµ‹è¯•
2. ç¼“å­˜å‘½ä¸­ç‡éªŒè¯
3. ç”Ÿäº§ç¯å¢ƒç°åº¦

---

## ğŸ“ ç›‘æ§æŒ‡æ ‡

éœ€è¦è¿½è¸ªçš„å…³é”®æŒ‡æ ‡ï¼š
- âœ… Rerank modelåŠ è½½æ—¶é—´
- âœ… ç¼“å­˜å‘½ä¸­ç‡
- âœ… ç¼“å­˜æ·˜æ±°æ¬¡æ•°
- âœ… ç¼“å­˜è¿‡æœŸæ¬¡æ•°
- âœ… Rerankingæ€»è€—æ—¶
- âœ… å…³é”®è¯æå–è€—æ—¶

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å†…å­˜ç®¡ç†**ï¼š
   - Rerankæ¨¡å‹å¯èƒ½å¾ˆå¤§ï¼ˆå‡ ç™¾MBåˆ°å‡ GBï¼‰
   - éœ€è¦åˆç†è®¾ç½®ç¼“å­˜å¤§å°
   - å»ºè®®ï¼šCACHE_MAX_SIZE = 20-50

2. **TTLè®¾ç½®**ï¼š
   - Rerankæ¨¡å‹é…ç½®å˜æ›´ä¸é¢‘ç¹
   - å»ºè®®TTL = 30-60åˆ†é’Ÿ

3. **çº¿ç¨‹å®‰å…¨**ï¼š
   - å¿…é¡»ä½¿ç”¨é”ä¿æŠ¤ç¼“å­˜æ“ä½œ
   - ä½¿ç”¨åŒé‡æ£€æŸ¥é”å®šä¼˜åŒ–æ€§èƒ½

4. **å‘åå…¼å®¹**ï¼š
   - ä¿æŒç°æœ‰APIä¸å˜
   - ç¼“å­˜ä¸ºå¯é€‰åŠŸèƒ½
   - æ¸è¿›å¼è¿ç§»

---

## ğŸ¯ æ€»ç»“

é€šè¿‡å®æ–½ä¸Šè¿°ä¼˜åŒ–æ–¹æ¡ˆï¼Œé¢„æœŸï¼š

âœ… **Rerankæ€§èƒ½æå‡**: 80-90%  
âœ… **ç¼“å­˜å‘½ä¸­ç‡**: 85%+  
âœ… **å†…å­˜å¯æ§**: é€šè¿‡LRUå’ŒTTLç®¡ç†  
âœ… **ä»£ç è´¨é‡**: å‡å°‘é‡å¤ï¼Œæå‡å¯ç»´æŠ¤æ€§  
âœ… **ç”¨æˆ·ä½“éªŒ**: å“åº”æ—¶é—´æ˜¾è‘—é™ä½  

**ROIæœ€é«˜çš„ä¼˜åŒ–**ï¼šModelç¼“å­˜ + Embeddingç¼“å­˜ï¼Œå®æ–½æˆæœ¬ä½ï¼Œæ”¶ç›Šæœ€å¤§ã€‚
